const path = require('path');
const sqlite3 = require('sqlite3').verbose();

const dbPath = path.join(__dirname, 'database.sqlite');
const db = new sqlite3.Database(dbPath);

console.log('üìö Insertando sesiones de prueba...');

// Funci√≥n para generar fechas de la pr√≥xima semana
function generarFechasSemanaProxima() {
  const fechas = [];
  const hoy = new Date();
  const inicioSemana = new Date(hoy);
  inicioSemana.setDate(hoy.getDate() + (7 - hoy.getDay() + 1)); // Pr√≥ximo lunes
  
  for (let i = 0; i < 6; i++) { // Lunes a S√°bado
    const fecha = new Date(inicioSemana);
    fecha.setDate(inicioSemana.getDate() + i);
    fechas.push(fecha.toISOString().split('T')[0]);
  }
  return fechas;
}

// Funci√≥n para obtener plantillas de horarios de trabajo desde la BD
function obtenerPlantillasHorarios() {
  return new Promise((resolve, reject) => {
    const query = `
      SELECT psicologoId, dia_semana, hora_inicio, hora_fin, modalidades 
      FROM horarios_trabajo 
      WHERE activo = 1
      ORDER BY psicologoId, dia_semana, hora_inicio
    `;
    
    db.all(query, [], (err, plantillas) => {
      if (err) {
        reject(err);
      } else {
        // Agrupar por psic√≥logo
        const plantillasPorPsicologo = {};
        plantillas.forEach(plantilla => {
          if (!plantillasPorPsicologo[plantilla.psicologoId]) {
            plantillasPorPsicologo[plantilla.psicologoId] = [];
          }
          plantillasPorPsicologo[plantilla.psicologoId].push({
            diaSemana: plantilla.dia_semana,
            horaInicio: plantilla.hora_inicio,
            horaFin: plantilla.hora_fin,
            modalidades: JSON.parse(plantilla.modalidades)
          });
        });
        resolve(plantillasPorPsicologo);
      }
    });
  });
}

// Funci√≥n para generar intervalos de horarios desde plantillas
function generarIntervalosDesdeBloque(horaInicio, horaFin, duracionMinutos = 60, bufferMinutos = 15) {
  const intervalos = [];
  
  const [horaIni, minIni] = horaInicio.split(':').map(Number);
  const [horaFin_, minFin] = horaFin.split(':').map(Number);
  
  const inicioMinutos = horaIni * 60 + minIni;
  const finMinutos = horaFin_ * 60 + minFin;
  const intervaloTotal = duracionMinutos + bufferMinutos;
  
  for (let minutos = inicioMinutos; minutos + duracionMinutos <= finMinutos; minutos += intervaloTotal) {
    const horaInicioIntervalo = minutosAHora(minutos);
    intervalos.push(horaInicioIntervalo);
  }
  
  return intervalos;
}

function minutosAHora(minutos) {
  const horas = Math.floor(minutos / 60);
  const mins = minutos % 60;
  return `${horas.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
}

// Funci√≥n ACTUALIZADA para generar sesiones de prueba usando plantillas
async function generarSesionesPrueba() {
  const fechas = generarFechasSemanaProxima();
  const modalidades = ['online', 'presencial'];
  const especialidades = ['Ansiedad', 'Depresi√≥n', 'Terapia de Pareja', 'Estr√©s', 'Autoestima', 'Terapia Cognitivo-Conductual'];
  const estados = ['confirmada', 'pendiente'];
  
  const pacientes = [
    {
      nombre: 'Juan P√©rez',
      email: 'juan@correo.com',
      telefono: '+52 555 123 4567'
    },
    {
      nombre: 'Mar√≠a Garc√≠a',
      email: 'maria@correo.com',
      telefono: '+52 555 987 6543'
    },
    {
      nombre: 'Carlos L√≥pez',
      email: 'carlos@correo.com',
      telefono: '+52 555 456 7890'
    },
    {
      nombre: 'Ana Rodr√≠guez',
      email: 'ana@correo.com',
      telefono: '+52 555 321 0987'
    },
    {
      nombre: 'Luis Mart√≠n',
      email: 'luis@correo.com',
      telefono: '+52 555 654 3210'
    },
    {
      nombre: 'Sofia Hern√°ndez',
      email: 'sofia@correo.com',
      telefono: '+52 555 789 0123'
    }
  ];

  // Obtener plantillas de horarios desde la BD
  const plantillasPorPsicologo = await obtenerPlantillasHorarios();
  const psicologosIds = Object.keys(plantillasPorPsicologo);

  const sesiones = [];
  const horariosUsados = {}; // Para rastrear horarios por psic√≥logo y fecha
  
  let sesionId = 1;
  
  // Generar 2 sesiones por psic√≥logo distribuidas en la semana
  psicologosIds.forEach(psicologoId => {
    let sesionesGeneradas = 0;
    
    fechas.forEach((fecha, fechaIndex) => {
      if (sesionesGeneradas >= 2) return; // M√°ximo 2 sesiones por psic√≥logo
      
      const fechaObj = new Date(fecha + 'T00:00:00');
      const diaSemana = fechaObj.getDay(); // 0=Domingo, 1=Lunes, etc.
      
      if (diaSemana === 0) return; // Saltar domingo
      
      // Buscar plantilla para este d√≠a
      const plantillasDelDia = plantillasPorPsicologo[psicologoId]?.filter(p => p.diaSemana === diaSemana) || [];
      
      if (plantillasDelDia.length === 0) return;
      
      // Generar horarios disponibles desde las plantillas
      let horariosDisponibles = [];
      plantillasDelDia.forEach(plantilla => {
        const intervalos = generarIntervalosDesdeBloque(plantilla.horaInicio, plantilla.horaFin);
        intervalos.forEach(hora => {
          horariosDisponibles.push({
            hora,
            modalidades: plantilla.modalidades
          });
        });
      });
      
      if (horariosDisponibles.length === 0) return;
      
      // Inicializar horarios usados para este psic√≥logo y fecha
      const clave = `${psicologoId}_${fecha}`;
      if (!horariosUsados[clave]) {
        horariosUsados[clave] = [];
      }
      
      // Encontrar un horario disponible
      const horariosLibres = horariosDisponibles.filter(horarioData => 
        !horariosUsados[clave].includes(horarioData.hora)
      );
      
      if (horariosLibres.length > 0) {
        const horarioSeleccionado = horariosLibres[Math.floor(Math.random() * horariosLibres.length)];
        const paciente = pacientes[sesionId % pacientes.length];
        const modalidadDisponible = horarioSeleccionado.modalidades[Math.floor(Math.random() * horarioSeleccionado.modalidades.length)];
        const especialidad = especialidades[Math.floor(Math.random() * especialidades.length)];
        const estado = estados[Math.floor(Math.random() * estados.length)];
        
        sesiones.push({
          id: `sesion_test_${String(sesionId).padStart(3, '0')}`,
          psicologoId: psicologoId,
          fecha: fecha,
          hora: horarioSeleccionado.hora,
          modalidad: modalidadDisponible,
          pacienteNombre: paciente.nombre,
          pacienteEmail: paciente.email,
          pacienteTelefono: paciente.telefono,
          especialidad: especialidad,
          estado: estado
        });
        
        // Marcar este horario como usado
        horariosUsados[clave].push(horarioSeleccionado.hora);
        sesionesGeneradas++;
        sesionId++;
      }
    });
  });
  
  return sesiones;
}

async function insertarSesiones() {
  return new Promise(async (resolve, reject) => {
    try {
      // Generar las sesiones de prueba desde las plantillas
      console.log('üîÑ Generando sesiones desde plantillas de horarios...');
      const sesionesPrueba = await generarSesionesPrueba();
      
      console.log(`üìù Insertando ${sesionesPrueba.length} sesiones de prueba...`);
    
    // Primero, limpiar sesiones existentes que puedan ser de prueba
    db.run("DELETE FROM sesiones WHERE id LIKE 'sesion_test_%'", (err) => {
      if (err) {
        console.log('‚ö†Ô∏è  Error limpiando sesiones anteriores:', err.message);
      } else {
        console.log('üßπ Sesiones de prueba anteriores eliminadas');
      }
      
      const insertQuery = `
        INSERT INTO sesiones (id, psicologoId, fecha, hora, modalidad, pacienteNombre, pacienteEmail, pacienteTelefono, especialidad, estado)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
      `;
      
      let insertadas = 0;
      let errores = 0;
      
      sesionesPrueba.forEach((sesion, index) => {
        db.run(insertQuery, [
          sesion.id,
          sesion.psicologoId,
          sesion.fecha,
          sesion.hora,
          sesion.modalidad,
          sesion.pacienteNombre,
          sesion.pacienteEmail,
          sesion.pacienteTelefono,
          sesion.especialidad,
          sesion.estado
        ], function(err) {
          if (err) {
            console.error(`‚ùå Error insertando sesi√≥n ${sesion.id}:`, err.message);
            errores++;
          } else {
            console.log(`‚úÖ Sesi√≥n insertada: ${sesion.pacienteNombre} - ${sesion.fecha} ${sesion.hora} (Psic√≥logo ${sesion.psicologoId})`);
            insertadas++;
          }
          
          // Si es la √∫ltima sesi√≥n, mostrar resumen
          if (index === sesionesPrueba.length - 1) {
            setTimeout(() => {
              console.log('\nüìä RESUMEN:');
              console.log(`‚úÖ Sesiones insertadas exitosamente: ${insertadas}`);
              console.log(`‚ùå Errores: ${errores}`);
              console.log('\nüë• USUARIOS DE PRUEBA:');
              
              // Contar sesiones por usuario
              const usuariosSesiones = {};
              sesionesPrueba.forEach(sesion => {
                if (!usuariosSesiones[sesion.pacienteEmail]) {
                  usuariosSesiones[sesion.pacienteEmail] = 0;
                }
                usuariosSesiones[sesion.pacienteEmail]++;
              });
              
              Object.entries(usuariosSesiones).forEach(([email, count]) => {
                console.log(`‚Ä¢ ${email} - ${count} sesiones`);
              });
              
              console.log('\nüîë Puedes iniciar sesi√≥n con cualquiera de estos emails para ver sus sesiones.');
              console.log('\nüìÖ Fechas generadas para la pr√≥xima semana:');
              
              const fechasUnicas = [...new Set(sesionesPrueba.map(s => s.fecha))];
              fechasUnicas.forEach(fecha => {
                const fechaObj = new Date(fecha + 'T00:00:00');
                const diasSemana = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
                const diaNombre = diasSemana[fechaObj.getDay()];
                console.log(`‚Ä¢ ${fecha} (${diaNombre})`);
              });
              
              resolve();
            }, 100);
          }
        });
      });
    });
    } catch (error) {
      console.error('‚ùå Error generando o insertando sesiones:', error);
      reject(error);
    }
  });
}

// Ejecutar la inserci√≥n
insertarSesiones()
  .then(() => {
    console.log('\nüéâ ¬°Sesiones de prueba insertadas exitosamente!');
    console.log('‚ö†Ô∏è  Las sesiones fueron generadas para evitar superposiciones');
    console.log('üìã Se respetaron los horarios de trabajo: Lun-Vie 09:00-18:00, S√°b 10:00-14:00');
    db.close();
  })
  .catch(error => {
    console.error('üí• Error general:', error);
    db.close();
    process.exit(1);
  }); 